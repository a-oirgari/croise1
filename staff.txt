let employees = [];

const unassignedList = document.getElementById('unassignedList');
const addForm = document.getElementById('addEmployeeForm');
const profileModal = document.getElementById('profileModal');
const profileContent = document.getElementById('profileContent');
const closeProfile = document.getElementById('closeProfile');

function generateId() {
  return String(Date.now()) + Math.floor(Math.random() * 1000);
}

function collectExperiences() {
  return Array.from(document.querySelectorAll('#experiences input')).map(i => i.value).filter(Boolean);
}

addForm.addEventListener('submit', (e) => {
  e.preventDefault();

  const emp = {
    id: generateId(),
    name: document.getElementById('name').value.trim(),
    role: document.getElementById('role').value.trim(),
    photo: document.getElementById('photo').value.trim(),
    email: document.getElementById('email').value.trim(),
    phone: document.getElementById('phone').value.trim(),
    experiences: collectExperiences(),
    zone: null,
  };

  employees.push(emp);
  renderUnassigned();

  // ‚úî Correction demand√©e : auto-fermeture
  document.getElementById('addModal').classList.add('hidden');

  addForm.reset();
  document.getElementById('experiences').innerHTML = '';
});

function createEmployeeNode(emp) {
  const li = document.createElement('li');
  li.className = 'bg-white p-2 rounded shadow flex items-center gap-3 hover:shadow-md';
  li.dataset.id = emp.id;

  li.innerHTML = `
    <img src="${emp.photo || 'https://via.placeholder.com/48'}" class="w-12 h-12 rounded object-cover" />
    <div class="flex-1 cursor-pointer openProfileBtn">
      <div class="font-semibold">${emp.name}</div>
      <div class="text-xs text-gray-600">${emp.role}</div>
    </div>

    <div class="flex gap-2">
      <button class="editBtn text-blue-600 text-sm">‚úèÔ∏è</button>
      <button class="deleteBtn text-red-600 text-sm">üóëÔ∏è</button>
    </div>
  `;

  li.querySelector('.openProfileBtn').addEventListener('click', () => openProfile(emp.id));
  li.querySelector('.editBtn').addEventListener('click', () => editEmployee(emp.id));
  li.querySelector('.deleteBtn').addEventListener('click', () => deleteEmployee(emp.id));

  return li;
}


function renderUnassigned() {
  unassignedList.innerHTML = '';
  employees.filter(e => !e.zone).forEach(emp => unassignedList.appendChild(createEmployeeNode(emp)));
  refreshAllZones();
}

function assignEmployeeToZone(empId, zoneKey) {
  const emp = employees.find(e => e.id === empId);
  if (!emp) return;

  const meta = window.zonesMeta[zoneKey];
  const zoneEl = document.getElementById(meta.id);
  const occ = zoneEl.querySelector('.zone-occupants');

  if (occ.children.length >= meta.capacity) {
    alert('Capacit√© atteinte');
    return;
  }

  if (!window.isEligibleForZone(emp, zoneKey)) {
    alert("Non autoris√©");
    return;
  }

  emp.zone = zoneKey;

  const card = document.createElement('div');
  card.className = 'bg-white p-2 rounded shadow flex items-center justify-between';
  card.dataset.id = emp.id;
  card.innerHTML = `
    <div class="flex items-center gap-2">
      <img src="${emp.photo}" class="w-10 h-10 rounded object-cover">
      <div>
        <div class="font-semibold text-sm">${emp.name}</div>
        <div class="text-xs text-gray-600">${emp.role}</div>
      </div>
    </div>
    <button class="removeBtn text-red-600">X</button>
  `;

  occ.appendChild(card);

  const node = unassignedList.querySelector(`[data-id="${emp.id}"]`);
  if (node) node.remove();

  card.querySelector('.removeBtn').addEventListener('click', () => removeFromZone(emp.id, zoneKey));

  refreshAllZones();
}

function removeFromZone(empId, zoneKey) {
  const emp = employees.find(e => e.id === empId);
  emp.zone = null;

  const zoneEl = document.getElementById(window.zonesMeta[zoneKey].id);
  const card = zoneEl.querySelector(`[data-id='${empId}']`);
  if (card) card.remove();

  renderUnassigned();
}

function openProfile(empId) {
  const emp = employees.find(e => e.id === empId);
  profileContent.innerHTML = `
    <div class="flex gap-4">
      <img src="${emp.photo}" class="w-28 h-28 rounded object-cover" />
      <div>
        <h3 class="text-xl font-semibold">${emp.name}</h3>
        <div>${emp.role}</div>
        <div class="text-sm mt-2">üìß ${emp.email}</div>
        <div class="text-sm">üìû ${emp.phone}</div>
        <div class="mt-2 text-sm">Localisation : <strong>${emp.zone || 'Unassigned'}</strong></div>
      </div>
    </div>
    <div class="mt-3">
      <h4 class="font-semibold">Exp√©riences :</h4>
      <ul class="list-disc ml-5 mt-1">
        ${emp.experiences.map(e => `<li>${e}</li>`).join('')}
      </ul>
    </div>
  `;

  profileModal.classList.remove('hidden');
}

closeProfile.addEventListener('click', () => profileModal.classList.add('hidden'));

function refreshAllZones() {
  Object.keys(window.zonesMeta).forEach(key => {
    const zoneEl = document.getElementById(window.zonesMeta[key].id);
    zoneEl.querySelector('.zone-occupants').innerHTML = '';
  });

  employees.filter(e => e.zone).forEach(emp => {
    assignEmployeeToZone(emp.id, emp.zone);
  });

  window.refreshZoneIndicators();
}

window.employees = employees;
window.assignEmployeeToZone = assignEmployeeToZone;
window.removeFromZone = removeFromZone;
